<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');class Penjualan extends CI_Controller {		function __construct()	{		parent::__construct();		if (!$this->ion_auth->logged_in())		{			//redirect them to the login page			echo '<h4 style="margin-top:10px; display:block; text-align:left"><i class="fa fa-warning txt-color-orangeDark"></i> Your login is expired click <a href="'.base_url().'">here</a> to relogin.</h4>';			die;		}				$this->load->library('Datatables');		$this->load->model('penjualan_model');	}		public function index()	{		//check session alert		$alert = $this->session->userdata('alert_msg');		if ($alert != "") {			$this->session->unset_userdata('alert_msg');		}		$alert != "" ? $disp = '' : $disp = 'display: none;';		$data['alert_block'] = '			<div class="alert alert-block alert-success" style="'.$disp.'" id="alert_table">				<a href="#" data-dismiss="alert" class="close">x</a>				<h4 class="alert-heading"><i class="fa fa-check-square-o"></i> Alert!</h4>				<p class="alert_msg">'.$alert.'</p>			</div>';		// Load the template from the views directory        $this->parser->parse("penjualan.tpl", $data);	}		public function table_list(){		$this->datatables->select('ref_code,								   po_customer,								   customers.nama_customer as customer,								   jumlah,								   tanggal_penjualan,								   status,								   users.username as created_by,								   idtransaksi_penjualan')            ->from('transaksi_penjualan')			->where('type','retail')			//->edit_column('name', '$1', 'strtolower(name)') // php functions			->edit_column('idtransaksi_penjualan', '$1', 'penjualan', 'callback_actions(idtransaksi_penjualan)');		$this->datatables->join('customers', 'transaksi_penjualan.idcustomer = customers.idcustomer', 'left');		$this->datatables->join('users', 'transaksi_penjualan.created_by = users.id', 'left');		        echo $this->datatables->generate();	}		public function callback_actions($id){		return '<nav class="col-xs-6 col-sm-6 col-md-6 col-lg-6">					<a class="btn btn-success btn-sm" href="'.base_url().'penjualan/add/'.$id.'">						<i class="fa fa-edit"></i> <span class="hidden-mobile">Edit Row</span>					</a>									</nav>					<a class="btn btn-success btn-sm" href="#'.base_url().'penjualan/view/'.$id.'">						<i class="fa fa-view"></i> <span class="hidden-mobile">View Detail</span>					</a>				';	}		function get_name($table,$field,$find,$value,$add_where=""){	   if(!empty($value)){		   //echo "select ".$field." as result from ".$table." where ".$find."='".$value."' ".$add_where;die();		   $q = $this->db->query("select ".$field." as result from ".$table." where ".$find."='".$value."' ".$add_where);		   $rows = $q->result_array();		   		   if(@$rows[0]){				return @$rows[0]['result'];		   }		   else{			   write_log( "parse error/empty result for : select ".$field." as result from ".$table." where ".$find."='".$value."' ".$add_where);		   }	   }	   else{		   return 0;	   }	}		public function add(){		$data[''] = "";		$id = $this->uri->segment(3);		if($id){			$this->db->select("*")->from("transaksi_penjualan")->where("idtransaksi_penjualan",$id);			$q = $this->db->get();			$d = $q->result_array();						//detail			$this->db->select("*")->from("transaksi_penjualan_detail")->where("ref_code",$d[0]['ref_code']);			$qd = $this->db->get();			//echo $this->db->last_query();			$dd = $qd->result_array();						$html_detail = "";			$i = 0;						foreach($dd as $k=>$v){				if(empty($dd[$k]['stock'])){					$location = "Jakarta";				}				else{					$location = "Surabaya";				}				$html_detail.="<tr id='list_".$i."'>								  <td><input type='hidden' name='jumlah[]' value='".$dd[$k]['jumlah']."' />".$dd[$k]['jumlah']."</td>								  <td><input type='hidden' name='idref_level[]' value='".$dd[$k]['idref_level']."' />".$this->get_name("ref_level","nilai","idref",$dd[$k]['idref_level'])."</td>								  <td><input type='hidden' name='idref_tinggi[]' value='".$dd[$k]['idref_tinggi']."' />".$this->get_name("ref_tinggi","concat(nilai,' ',satuan)","idref",$dd[$k]['idref_tinggi'])."</td>								  <td><input type='hidden' name='idref_beam[]' value='".$dd[$k]['idref_beam']."' />".$this->get_name("ref_beam","concat(nilai,' ',satuan)","idref",$dd[$k]['idref_beam'])."</td>								  <td><input type='hidden' name='idref_depth[]' value='".$dd[$k]['idref_depth']."' />".$this->get_name("ref_depth","concat(nilai,' ',satuan)","idref",$dd[$k]['idref_depth'])."</td>								  <td><input type='hidden' name='idref_ambalan[]' value='".$dd[$k]['idref_ambalan']."' />".$this->get_name("ref_ambalan","nilai","idref",$dd[$k]['idref_ambalan'])."</td>								  <td><input type='hidden' name='idref_footplate[]' value='".$dd[$k]['idref_footplate']."' />".$this->get_name("ref_footplate","nilai","idref",$dd[$k]['idref_footplate'])."</td>								  <td><input type='hidden' name='idref_accessories[]' value='".$dd[$k]['idref_accessories']."' />".$this->get_name("ref_accessories","nilai","idref",$dd[$k]['idref_accessories'])."</td>								  <td><input type='hidden' name='idref_accessories[]' value='".$dd[$k]['idref_center_support']."' />".$this->get_name("ref_center_support","nilai","idref",$dd[$k]['idref_center_support'])."</td>								  <td><input type='hidden' name='stock[]' value='".$dd[$k]['stock']."' />".$location."</td>								  <td><a href='javascript:void(0);' onclick='removeList(".$i.");' class='btn btn-danger'> &nbsp;&nbsp;<i class='fa fa-trash-o'></i> Remove &nbsp;&nbsp;</a></td>							   </tr>";				$i++;			}			$data['cond'] = "Edit";			$data['stat_cond'] = "update";			$data['detail']['list_option_customer'] = $this->getListCustomer($d[0]['idcustomer']);			$data['detail']['po_customer'] = $d[0]['po_customer'];			$data['detail']['idtransaksi_penjualan'] = $d[0]['idtransaksi_penjualan'];			$data['detail']['tanggal_penjualan'] = date("d-m-Y",strtotime($d[0]['tanggal_penjualan']));			$data['detail']['list_option_ref_level'] = $this->getRefList('ref_level');			$data['detail']['list_option_ref_tinggi'] = $this->getRefList('ref_tinggi');			$data['detail']['list_option_ref_beam'] = $this->getRefList('ref_beam');			//$data['detail']['list_option_ref_depth'] = $this->getRefList('ref_depth');			$data['detail']['list_option_ref_ambalan'] = $this->getRefList('ref_ambalan',0,'N');			$data['detail']['list_option_ref_footplate'] = $this->getRefList('ref_footplate');			$data['detail']['list_option_ref_accessories'] = $this->getRefList('ref_accessories',0,'N');			$data['detail']['list_option_ref_center_support'] = $this->getRefList('ref_center_support',0,'N');			$data['detail']['index'] = $i;			$data['detail']['list_edit'] = $html_detail;		}		else{			$data['cond'] = "Add";			$data['stat_cond'] = "insert";			$data['detail']['list_option_customer'] = $this->getListCustomer(0);			$data['detail']['po_customer'] = "";			$data['detail']['tanggal_penjualan'] = date("d-m-Y");			$data['detail']['list_option_ref_level'] = $this->getRefList('ref_level');			$data['detail']['list_option_ref_tinggi'] = $this->getRefList('ref_tinggi');			$data['detail']['list_option_ref_beam'] = $this->getRefList('ref_beam');			//$data['detail']['list_option_ref_depth'] = $this->getRefList('ref_depth');			$data['detail']['list_option_ref_ambalan'] = $this->getRefList('ref_ambalan',0,'N');			$data['detail']['list_option_ref_footplate'] = $this->getRefList('ref_footplate');			$data['detail']['list_option_ref_accessories'] = $this->getRefList('ref_accessories',0,'N');			$data['detail']['list_option_ref_center_support'] = $this->getRefList('ref_center_support',0,'N');			$data['detail']['list_edit'] = "";			$data['detail']['index'] = 0;		}        $this->parser->parse("add_penjualan.tpl", $data);	}		public function getRefList($table,$id=0,$required="Y"){		$this->db->select("*")->from($table);		$q = $this->db->get();		$d = $q->result_array();		//echo $this->db->last_query();		$html = "";		$selected = "";		$satuan = "";		if($required=="N"){			$html.="<option value=''>- Not Set -</option>";		}		foreach($d as $k=>$v){			if($d[$k]["idref"]==$id){				$selected = "selected = 'selected'";			}			if(isset($d[$k]["satuan"])){				$satuan = $d[$k]["satuan"];			}			if(isset($d[$k]["nilai"])){				$text = $d[$k]["nilai"];			}			if(isset($d[$k]["nilai"])){				$text = $d[$k]["nilai"];			}			if(isset($d[$k]["nilai"])){				$text = $d[$k]["nilai"];			}			if($table=="ref_level"){				$html.="<option value='".$d[$k]["nilai"]."' ".$selected.">".$text." level</option>";			}			else{				$html.="<option value='".$d[$k]["idref"]."' ".$selected.">".$text." ".$satuan."</option>";			}			$selected = "";		}				return $html;	}		public function getListCustomer($id){		$this->db->select("*")->from("customers");		$q = $this->db->get();		$d = $q->result_array();		//echo $this->db->last_query();		$html = "";		$selected = "";		foreach($d as $k=>$v){			if($d[$k]["idcustomer"]==$id){				$selected = "selected = 'selected'";			}			$html.="<option value='".$d[$k]["idcustomer"]."' ".$selected.">".$d[$k]["nama_customer"]."</option>";			$selected = "";		}				return $html;	}		public function getLastTrxID($prefix){		$this->db->select("ref_code")->from("transaksi_penjualan")->order_by("idtransaksi_penjualan desc")->limit(1);		$q = $this->db->get();		$d = $q->result_array();		if(!empty($d)){			$last_trx_code = $d[0]['ref_code'];			//PNJ-01022014-0001			$last_number = substr($last_trx_code,12,4);			$next = (int)$last_number+1;		}		else{			$next = 1;		}		$number = $prefix.date("dmY").sprintf("%04d",$next);		return $number;	}		function clear_html($v){		return htmlspecialchars($v,ENT_QUOTES);	}		public function cekstock($id,$jml,$type,$location=""){		if(!empty($id)){			$this->db->select("*")->from("barang");			$this->db->where("idtipe_barang",$type,false);			$this->db->where("idref",$id,false);			$q = $this->db->get();			//echo $this->db->last_query();			$n = $q->num_rows();			if(!empty($n)){				$d = $q->result_array();				if($jml<=$d[0]['quantity'.$location]){					$data['status'] = true;					$data['current_stock'] = $d[0]['quantity'.$location];				}				else{					$data['status'] = false;					$data['current_stock'] = $d[0]['quantity'.$location];				}			}			else{				$data['status'] = false;				$data['current_stock'] = 0;			}			return $data;		}		else{			$data['status'] = true;			return $data;		}	}		public function checkInputStock(){			$jml_meja = $_POST['jumlah'];			$location = $_POST['location'];			$level = $_POST['idref_level'];						if(!empty($_POST['idref_ambalan'])){				//cek ambalan				$jml_ambalan = $level*1*$jml_meja;				$id_ambalan = $_POST['idref_ambalan'];				$cek_ambalan = $this->cekstock($_POST['idref_ambalan'],$jml_ambalan,3,$location);				if(!$cek_ambalan['status']){					$data['error'] = true;					$data['field'][0]["name"] = "idref_ambalan";					$data['field'][0]["message"] = "Stok ambalan tidak memenuhi (".$jml_ambalan."/".$cek_ambalan['current_stock'].")";					echo json_encode($data);					exit;				}			}						//cek depth			/* $jml_depth = $level*$jml_meja;			$id_depth = $_POST['idref_beam'];			$cek_depth = $this->cekstock($_POST['idref_beam'],$jml_depth,3);			if(!$cek_depth['status']){				$data['error'] = true;				$data['field'][0]["name"] = "idref_beam";				$data['field'][0]["message"] = "Stok depth tidak memenuhi (".$jml_depth."/".$cek_depth['current_stock'].")";				echo json_encode($data);				exit;			} */						if(!empty($_POST['idref_beam'])){				//cek width				$jml_width = $level*$jml_meja;				$id_width = $_POST['idref_beam'];				$cek_width = $this->cekstock($_POST['idref_beam'],$jml_width,2,$location);				if(!$cek_width['status']){					$data['error'] = true;					$data['field'][0]["name"] = "idref_beam";					$data['field'][0]["message"] = "Stok beam tidak memenuhi (".$jml_width."/".$cek_width['current_stock'].")";					echo json_encode($data);					exit;				}			}						if(!empty($_POST['idref_tinggi'])){				//cek height				$jml_height = 4*$jml_meja;				$id_height = $_POST['idref_tinggi'];				$cek_height = $this->cekstock($_POST['idref_tinggi'],$jml_height,1,$location);				if(!$cek_height['status']){					$data['error'] = true;					$data['field'][0]["name"] = "idref_tinggi";					$data['field'][0]["message"] = "Stok height tidak memenuhi (".$jml_height."/".$cek_height['current_stock'].")";					echo json_encode($data);					exit;				}			}						if(!empty($_POST['idref_footplate'])){				//cek footplate				$jml_footplate = 4*$jml_meja;				$id_footplate = $_POST['idref_footplate'];				$cek_footplate = $this->cekstock($_POST['idref_footplate'],$jml_footplate,4,$location);				if(!$cek_footplate['status']){					$data['error'] = true;					$data['field'][0]["name"] = "idref_footplate";					$data['field'][0]["message"] = "Stok footplate tidak memenuhi (".$jml_footplate."/".$cek_footplate['current_stock'].")";					echo json_encode($data);					exit;				}			}									if(!empty($_POST['idref_accessories'])){				//accessories				$jml_accessories = $jml_meja;				$id_accessories = $_POST['idref_accessories'];				$cek_accessories = $this->cekstock($_POST['idref_accessories'],$jml_accessories,5,$location);				if(!$cek_accessories['status']){					$data['error'] = true;					$data['field'][0]["name"] = "idref_accessories";					$data['field'][0]["message"] = "Stok accessories tidak memenuhi (".$jml_accessories."/".$cek_accessories['current_stock'].")";					echo json_encode($data);					exit;				}			}						if(!empty($_POST['idref_center_support'])){				//center_support				$jml_center_support = $jml_meja;				$id_center_support = $_POST['idref_center_support'];				$cek_center_support = $this->cekstock($_POST['idref_center_support'],$jml_center_support,6,$location);				if(!$cek_center_support['status']){					$data['error'] = true;					$data['field'][0]["name"] = "idref_center_support";					$data['field'][0]["message"] = "Stok accessories tidak memenuhi (".$jml_center_support."/".$cek_center_support['current_stock'].")";					echo json_encode($data);					exit;				}			}					$data['error'] = false;		echo json_encode($data);	}		public function insert(){		//checking stock		if(!empty($_POST['jumlah'])){				$this->db->trans_start();							//input parent				$total = 0;				foreach($_POST['jumlah'] as $k=>$v){					$total = $total + $_POST['jumlah'][$k];				}				$data_pnj['ref_code'] = $this->getLastTrxID("PNJR"); 				$data_pnj['tanggal_penjualan'] = date("Y-m-d",strtotime($_POST['tanggal_penjualan']));				$data_pnj['idcustomer'] = $_POST['idcustomer'];				$data_pnj['po_customer'] = $_POST['po_customer'];				$data_pnj['jumlah'] = $total;				$data_pnj['status'] = "in progress";				$data_pnj['type'] = "retail";				$data_pnj['created_date'] = date("Y-m-d H:i:s");				$data_pnj['created_by'] = $this->session->userdata('user_id');				$this->db->insert("transaksi_penjualan",$data_pnj);								//input detail				foreach($_POST['jumlah'] as $k=>$v){					$data_detail['jumlah'] = $_POST['jumlah'][$k];					$data_detail['ref_code'] = $data_pnj['ref_code'];					$data_detail['idref_level'] = $_POST['idref_level'][$k];					$data_detail['idref_tinggi'] = $_POST['idref_tinggi'][$k];					$data_detail['idref_beam'] = $_POST['idref_beam'][$k];					$data_detail['idref_center_support'] = $_POST['idref_center_support'][$k];					$data_detail['idref_ambalan'] = $_POST['idref_ambalan'][$k];					$data_detail['idref_footplate'] = $_POST['idref_footplate'][$k];					$data_detail['idref_accessories'] = $_POST['idref_accessories'][$k];					$data_detail['stock'] = $_POST['stock'][$k];					$this->db->insert("transaksi_penjualan_detail",$data_detail);				}			$this->db->trans_complete();			$this->session->set_userdata('alert_msg','Data sucessfully inserted');			$data['error'] = false;			echo json_encode($data);		}		else{			$data['field'][0]["name"] = "jumlah";			$data['field'][0]["message"] = "Please add item to list";			$data['error'] = true;			echo json_encode($data);		}	}		public function update(){		//print_r($_POST);		$this->db->trans_start();		$data_update['idcustomer'] = $_POST['idcustomer'];		$data_update['po_customer'] = $_POST['po_customer'];		$data_update['created_date'] = date("Y-m-d H:i:s");		$data_update['created_by'] = $this->session->userdata('user_id');		$data_update['tanggal_penjualan'] = date("Y-m-d",strtotime($_POST['tanggal_penjualan']));		$this->db->where('idtransaksi_penjualan',$_POST['idtransaksi_penjualan']);		$this->db->update("transaksi_penjualan",$data_update);				$ref_code = $this->get_name("transaksi_penjualan","ref_code","idtransaksi_penjualan",$_POST['idtransaksi_penjualan']);		$this->db->where("ref_code",$ref_code);		$this->db->delete("transaksi_penjualan_detail");				if(!empty($_POST['jumlah'])){			foreach($_POST['jumlah'] as $k=>$v){				$data_detail['jumlah'] = $_POST['jumlah'][$k];				$data_detail['ref_code'] = $ref_code;				$data_detail['idref_level'] = $_POST['idref_level'][$k];				$data_detail['idref_tinggi'] = $_POST['idref_tinggi'][$k];				$data_detail['idref_beam'] = $_POST['idref_beam'][$k];				$data_detail['idref_center_support'] = $_POST['idref_center_support'][$k];				$data_detail['idref_ambalan'] = $_POST['idref_ambalan'][$k];				$data_detail['idref_footplate'] = $_POST['idref_footplate'][$k];				$data_detail['idref_accessories'] = $_POST['idref_accessories'][$k];				$data_detail['stock'] = $_POST['stock'][$k];				$this->db->insert("transaksi_penjualan_detail",$data_detail);			}		}				$this->db->trans_complete();				$this->session->set_userdata('alert_msg','Data sucessfully updated');		$data['error'] = false;		echo json_encode($data);	}		public function view(){		$id_view = $this->uri->segment(3);		$this->db->select("a.ref_code,a.jumlah,a.status,a.tanggal_penjualan,b.nama_customer,b.jenis_kelamin,b.alamat,b.telp,b.fax,b.email,b.npwp")->from("transaksi_penjualan a")->where("idtransaksi_penjualan",$id_view,false);		$this->db->join("customers b","a.idcustomer=b.idcustomer","left");		$q = $this->db->get();		//echo $this->db->last_query();		$d = $q->result_array();				//detail		$this->db->select("a.jumlah,b.nilai as level,						   concat(c.nilai,' ',c.satuan) as tinggi,						   concat(d.nilai,' ',d.satuan) as beam,						   e.nilai as support_center,						   f.nilai as nama_ambalan,						   g.nilai as nama_footplate,						   h.nilai as nama_accessories",false)->from("transaksi_penjualan_detail a")->where("ref_code",$d[0]['ref_code']);		$this->db->join("ref_level b","a.idref_level=b.idref","left");		$this->db->join("ref_tinggi c","a.idref_tinggi=c.idref","left");		$this->db->join("ref_beam d","a.idref_beam=d.idref","left");		$this->db->join("ref_center_support e","a.idref_center_support=e.idref","left");		$this->db->join("ref_ambalan f","a.idref_ambalan=f.idref","left");		$this->db->join("ref_footplate g","a.idref_footplate=g.idref","left");		$this->db->join("ref_accessories h","a.idref_accessories=h.idref","left");		$qd = $this->db->get();		//echo $this->db->last_query();		$dd = $qd->result_array();				$detail_text = "";		foreach($dd as $k=>$v){			$detail_text .= "<tr>								<td>".$dd[$k]['jumlah']."</td>								<td>".$dd[$k]['level']."</td>								<td>".$dd[$k]['tinggi']."</td>								<td>".$dd[$k]['beam']."</td>								<td>".$dd[$k]['support_center']."</td>								<td>".$dd[$k]['nama_ambalan']."</td>								<td>".$dd[$k]['nama_footplate']."</td>								<td>".$dd[$k]['nama_accessories']."</td>							 </tr>";		}		if($d[0]['jenis_kelamin']=="L"){			$pref = "Mr. ";		}		else{			$pref = "Mrs. ";		}		$button_list = "";		if($d[0]['status']=="on delivery"){			$button_list = '<button class="btn btn-primary" onclick="document.location.replace(\''.base_url().'cpanel.html#penjualan/print_sj/'.$d[0]['ref_code'].'\')">												<i class="fa fa-envelope-o  "></i>												Print Surat Jalan											</button>											<button class="btn btn-primary" onclick="document.location.replace(\''.base_url().'cpanel.html#penjualan/print_invoice/'.$d[0]['ref_code'].'\')">												<i class="fa fa-money "></i>												Print Invoice											</button>';		}		$data['content'] = '				<div>					<small>Date : <strong>'.date("d/m/Y",strtotime($d[0]['tanggal_penjualan'])).'</strong>,  TRX NO : <strong>'.$d[0]['ref_code'].'</strong></small>					<h2>'.$pref.$d[0]['nama_customer'].'					<br>					<small> '.$d[0]['alamat'].'</small></h2>					<ul class="list-unstyled">						<li>							<p class="text-muted">								<i class="fa fa-phone"></i>&nbsp;&nbsp;/&nbsp;&nbsp;<i class="fa fa-file-text-o"></i> &nbsp;&nbsp; '.$d[0]['telp'].' / '.$d[0]['fax'].' 							</p>						</li>						<li>							<p class="text-muted">								<i class="fa fa-envelope"></i>&nbsp;&nbsp; <a class="btn btn-default btn-xs" href="mailto:'.$d[0]['email'].'"><i class="fa fa-envelope-o"></i> '.$d[0]['email'].'</a>							</p>						</li>						<li>							<p class="text-muted">								<i class="fa fa-envelope"></i>&nbsp;&nbsp; NPWP : &nbsp;<span class="txt-color-darken">'.$d[0]['npwp'].'</span>							</p>						</li>						<li>							<p class="text-muted">								<i class="fa fa-exchange"></i>&nbsp;&nbsp;<span class="txt-color-darken"><strong><a href="javascript:void(0)" onclick="updateStatusTrans(\''.$d[0]['ref_code'].'\',\''.$d[0]['status'].'\')">'.$d[0]['status'].'</a></strong></span>							</p>						</li> 						 					</ul>					<br>					<div class="table-responsive">									<table class="table table-bordered table-striped">										<thead>											<tr>												<th>Jumlah</th>												<th>Level</th>												<th>Tinggi</th>												<th>Lebar</th>												<th>Depth</th>												<th>Ambalan</th>												<th>Footplate</th>												<th>Accessories</th>											</tr>										</thead>										<tbody>											'.$detail_text.'										</tbody>									</table>														</div>					<form class="smart-form" novalidate="novalidate">						<footer>								<div class="row">									<div class="col-md-12">										<nav>											<a id="cancel" href="penjualan" class="btn btn-default">												Cancel											</a>										</nav>										'.$button_list.'									</div>								</div>							</footer>					</form>				</div>';				$this->parser->parse("view_penjualan.tpl", $data);			}		public function updateStatus(){		if($_POST['status']=='in progress'){			//print_r($_POST);die();			$this->db->trans_start();			//insert to gudang			$this->db->select("*")->from('transaksi_penjualan_detail')->where('ref_code',$_POST['ref']);			$q = $this->db->get();			$d = $q->result_array();			$no_surat_jalan = str_replace("PNJ","SJL",$_POST['ref']);			foreach($d as $k=>$v){				$data['ref_code'] = $_POST['ref'];				$ref = $_POST['ref'];				//tinggi				if(!empty($d[$k]['idref_tinggi'])){					$this->db->select("idbarang")->from("barang")->where("idref",$d[$k]['idref_tinggi'])->where('idtipe_barang',1);					$qd = $this->db->get();					//echo $this->db->last_query();die();					$dd = $qd->result_array();					$data['idbarang'] = $dd[0]['idbarang'];					$data['idtransaksi_penjualan_detail'] = $d[$k]['idtransaksi_penjualan_detail'];					$data['jumlah'.$d[$k]['stock']] = 4*$d[$k]['jumlah'];					$data['type'] = "keluar";					$data['no_surat_jalan'] = $no_surat_jalan;					$data['deskripsi'] 	= "Penjualan ".$ref;					$data['date'] = date("Y-m-d H:i:s");					$data['created_by'] = $this->session->userdata("user_id");					$this->db->insert("gudang",$data);					if($this->db->affected_rows()){						$this->db->query("update barang set quantity".$d[$k]['stock']." = quantity".$d[$k]['stock']." - ".$data['jumlah']." where idbarang = ".$dd[0]['idbarang']);					}					else{						echo "error query : ".$this->db->last_query();die();					}				}								//lebar				if(!empty($d[$k]['idref_beam'])){					$this->db->select("idbarang")->from("barang")->where("idref",$d[$k]['idref_beam'])->where('idtipe_barang',2);					$qd = $this->db->get();					$dd = $qd->result_array();					$data['idbarang'] = $dd[0]['idbarang'];					$data['idtransaksi_penjualan_detail'] = $d[$k]['idtransaksi_penjualan_detail'];					$data['jumlah'.$d[$k]['stock']] = $d[$k]['idref_level']*2*$d[$k]['jumlah'];					$data['type'] = "keluar";					$data['no_surat_jalan'] = $no_surat_jalan;					$data['deskripsi'] 	= "Penjualan ".$ref;					$data['date'] = date("Y-m-d H:i:s");					$data['created_by'] = $this->session->userdata("user_id");					$this->db->insert("gudang",$data);					if($this->db->affected_rows()){						$this->db->query("update barang set quantity".$d[$k]['stock']." = quantity".$d[$k]['stock']." - ".$data['jumlah']." where idbarang = ".$dd[0]['idbarang']);					}					else{						echo "error query : ".$this->db->last_query();die();					}				}								//depth				/* if(!empty($d[$k]['idref_depth'])){					$this->db->select("idbarang")->from("barang")->where("idref",$d[$k]['idref_depth'])->where('idtipe_barang',3);					$qd = $this->db->get();					$dd = $qd->result_array();					$data['idbarang'] = $dd[0]['idbarang'];					$data['idtransaksi_penjualan_detail'] = $d[$k]['idtransaksi_penjualan_detail'];					$data['jumlah'.$d[$k]['stock']] = $d[$k]['idref_level']*2*$d[$k]['jumlah'];					$data['type'] = "keluar";					$data['no_surat_jalan'] = $no_surat_jalan;					$data['deskripsi'] = "Penjualan ".$ref;					$data['date'] = date("Y-m-d H:i:s");					$data['created_by'] = $this->session->userdata("user_id");					$this->db->insert("gudang",$data);					if($this->db->affected_rows()){						$this->db->query("update barang set quantity".$d[$k]['stock']." = quantity".$d[$k]['stock']." - ".$data['jumlah']." where idbarang = ".$dd[0]['idbarang']);					}					else{						echo "error query : ".$this->db->last_query();die();					}				} */								//ambalan				if(!empty($d[$k]['idref_ambalan'])){					$this->db->select("idbarang")->from("barang")->where("idref",$d[$k]['idref_ambalan'])->where('idtipe_barang',3);					$qd = $this->db->get();					$dd = $qd->result_array();					$data['idbarang'] = $dd[0]['idbarang'];					$data['idtransaksi_penjualan_detail'] = $d[$k]['idtransaksi_penjualan_detail'];					$data['jumlah'.$d[$k]['stock']] = $d[$k]['idref_level']*1*$d[$k]['jumlah'];					$data['type'] = "keluar";					$data['no_surat_jalan'] = $no_surat_jalan;					$data['deskripsi'] = "Penjualan ".$ref;					$data['date'] = date("Y-m-d H:i:s");					$data['created_by'] = $this->session->userdata("user_id");					$this->db->insert("gudang",$data);					if($this->db->affected_rows()){						$this->db->query("update barang set quantity".$d[$k]['stock']." = quantity".$d[$k]['stock']." - ".$data['jumlah']." where idbarang = ".$dd[0]['idbarang']);					}					else{						echo "error query : ".$this->db->last_query();die();					}				}								//footplate				if(!empty($d[$k]['idref_footplate'])){					$this->db->select("idbarang")->from("barang")->where("idref",$d[$k]['idref_footplate'])->where('idtipe_barang',4);					$qd = $this->db->get();					$dd = $qd->result_array();					$data['idbarang'] = $dd[0]['idbarang'];					$data['idtransaksi_penjualan_detail'] = $d[$k]['idtransaksi_penjualan_detail'];					$data['jumlah'.$d[$k]['stock']] = 4*$d[$k]['jumlah'];					$data['type'] = "keluar";					$data['no_surat_jalan'] = $no_surat_jalan;					$data['deskripsi'] = "Penjualan ".$ref;					$data['date'] = date("Y-m-d H:i:s");					$data['created_by'] = $this->session->userdata("user_id");					$this->db->insert("gudang",$data);					if($this->db->affected_rows()){						$this->db->query("update barang set quantity".$d[$k]['stock']." = quantity".$d[$k]['stock']." - ".$data['jumlah']." where idbarang = ".$dd[0]['idbarang']);					}					else{						echo "error query : ".$this->db->last_query();die();					}				}								//accessories				if(!empty($d[$k]['idref_accessories'])){					$this->db->select("idbarang")->from("barang")->where("idref",$d[$k]['idref_accessories'])->where('idtipe_barang',5);					$qd = $this->db->get();					$dd = $qd->result_array();					$data['idbarang'] = $dd[0]['idbarang'];					$data['idtransaksi_penjualan_detail'] = $d[$k]['idtransaksi_penjualan_detail'];					$data['jumlah'.$d[$k]['stock']] = 4*$d[$k]['jumlah'];					$data['type'] = "keluar";					$data['no_surat_jalan'] = $no_surat_jalan;					$data['deskripsi'] = "Penjualan ".$ref;					$data['date'] = date("Y-m-d H:i:s");					$data['created_by'] = $this->session->userdata("user_id");					$this->db->insert("gudang",$data);					if($this->db->affected_rows()){						$this->db->query("update barang set quantity".$d[$k]['stock']." = quantity".$d[$k]['stock']." - ".$data['jumlah']." where idbarang = ".$dd[0]['idbarang']);					}					else{						echo "error query : ".$this->db->last_query();die();					}				}								//center support				if(!empty($d[$k]['idref_center_support'])){					$this->db->select("idbarang")->from("barang")->where("idref",$d[$k]['idref_center_support'])->where('idtipe_barang',6);					$qd = $this->db->get();					$dd = $qd->result_array();					$data['idbarang'] = $dd[0]['idbarang'];					$data['idtransaksi_penjualan_detail'] = $d[$k]['idtransaksi_penjualan_detail'];					$data['jumlah'.$d[$k]['stock']] = 4*$d[$k]['jumlah'];					$data['type'] = "keluar";					$data['no_surat_jalan'] = $no_surat_jalan;					$data['deskripsi'] = "Penjualan ".$ref;					$data['date'] = date("Y-m-d H:i:s");					$data['created_by'] = $this->session->userdata("user_id");					$this->db->insert("gudang",$data);					if($this->db->affected_rows()){						$this->db->query("update barang set quantity".$d[$k]['stock']." = quantity".$d[$k]['stock']." - ".$data['jumlah']." where idbarang = ".$dd[0]['idbarang']);					}					else{						echo "error query : ".$this->db->last_query();die();					}				}			}						$data_trans['status'] = "on delivery";			$this->db->where('ref_code',$_POST['ref']);			$this->db->update('transaksi_penjualan',$data_trans);			if(!$this->db->affected_rows()){				echo "error query : ".$this->db->last_query();die();			}			//echo $this->db->last_query();			$this->db->trans_complete();			echo "ok";		}				if($_POST['status']=='on delivery'){			$this->db->trans_start();			$main_data['status'] = "done";			$this->db->where('ref_code',$_POST['ref']);			$this->db->update('transaksi_penjualan',$main_data);			$this->db->trans_complete();						echo "ok";		}					}		public function print_sj(){		$this->db->select("*")->from("transaksi_penjualan")->where("ref_code",$this->uri->segment(3));		$q = $this->db->get();		$d = $q->result_array();				$this->db->select("*")->from("transaksi_penjualan_detail")->where("ref_code",$this->uri->segment(3));		$qd = $this->db->get();		$dd = $qd->result_array();				$total_unit = "";		/* foreach($dd as $k=>$v){			$total_unit.= $dd[$k]['jumlah']." unit ".$dd[$k]['idref_level']." level <br />";		} */								$this->db->select("*")->from("customers")->where("idcustomer",$d[0]['idcustomer']);		$qc = $this->db->get();		$dc = $qc->result_array();				$data['penjualan'] = $d[0];		$data['penjualan_detail'] = $dd;		$detail_content = '<table class="table table-hover">								<thead>									<tr>										<th>No</th>										<th>DESCRIPTION</th>										<th class="text-center">QTY</th>										<th>UNIT WEIGHT</th>										<th>TOTAL WEIGHT</th>									</tr>								</thead>								<tbody>								';		$grand_total = 0;		$i = 1;		foreach($dd as $kd=>$vd){			$total_unit = $dd[$kd]['jumlah']." unit ".$dd[$kd]['idref_level']." level";			$detail_content.='<tr>									<td colspan="5"><strong>'.$total_unit.'</strong></td>								</tr>';			$this->db->select("*")->from("gudang")->where("ref_code",$this->uri->segment(3))->where('type','keluar');			$this->db->where("idtransaksi_penjualan_detail",$dd[$kd]["idtransaksi_penjualan_detail"]);			$qgd = $this->db->get();			$dgd = $qgd->result_array();			$no_surat_jalan = @$dgd[0]['no_surat_jalan'];			foreach($dgd as $k=>$v){				$this->db->select("*")->from("barang")->where("idbarang",$dgd[$k]["idbarang"]);				$qb = $this->db->get();				$db = $qb->result_array();				$total_berat = $db[0]['berat']*$dgd[$k]['jumlah'];				$detail_content.='<tr>									<td class="text-center"><strong>'.$i.'</strong></td>									<td><a href="javascript:void(0);">'.$db[0]['nama_barang'].'</a></td>									<td class="text-center">'.$dgd[$k]['jumlah'].'</td>									<td>'.$db[0]['berat'].'</td>									<td>'.$total_berat.'</td>								</tr>';				$grand_total+=$total_berat;				$i++;			}		}		$detail_content.='<tr>										<td colspan="4">GRAND TOTAL</td>										<td><strong>'.$grand_total.' Kg</strong></td>									</tr>								</tbody>							</table>';		$data['no_surat_jalan'] = $no_surat_jalan;		$data['detail_content'] = $detail_content;		$data['customer'] = $dc[0];		$this->parser->parse("surat_jalan.tpl", $data);	}		public function printout_sj(){		require_once('dompdf/dompdf_config.inc.php');				$this->db->select("*")->from("transaksi_penjualan")->where("ref_code",$this->uri->segment(3));		$q = $this->db->get();		$d = $q->result_array();				$this->db->select("*")->from("transaksi_penjualan_detail")->where("ref_code",$this->uri->segment(3));		$qd = $this->db->get();		$dd = $qd->result_array();				$total_unit = "";		/* foreach($dd as $k=>$v){			$total_unit.= $dd[$k]['jumlah']." unit ".$dd[$k]['idref_level']." level <br />";		} */								$this->db->select("*")->from("customers")->where("idcustomer",$d[0]['idcustomer']);		$qc = $this->db->get();		$dc = $qc->result_array();				$data['penjualan'] = $d[0];		$data['penjualan_detail'] = $dd;		$detail_content = '<table class="table table-hover">								<thead>									<tr>										<th>No</th>										<th>DESCRIPTION</th>										<th class="text-center">QTY</th>										<th>UNIT WEIGHT</th>										<th>TOTAL WEIGHT</th>									</tr>								</thead>								<tbody>								';		$grand_total = 0;		$i = 1;		foreach($dd as $kd=>$vd){			$total_unit = $dd[$kd]['jumlah']." unit ".$dd[$kd]['idref_level']." level";			$detail_content.='<tr>									<td colspan="5"><strong>'.$total_unit.'</strong></td>								</tr>';			$this->db->select("*")->from("gudang")->where("ref_code",$this->uri->segment(3))->where('type','keluar');			$this->db->where("idtransaksi_penjualan_detail",$dd[$kd]["idtransaksi_penjualan_detail"]);			$qgd = $this->db->get();			$dgd = $qgd->result_array();			$no_surat_jalan = $dgd[0]['no_surat_jalan'];			foreach($dgd as $k=>$v){				$this->db->select("*")->from("barang")->where("idbarang",$dgd[$k]["idbarang"]);				$qb = $this->db->get();				$db = $qb->result_array();				$total_berat = $db[0]['berat']*$dgd[$k]['jumlah'];				$detail_content.='<tr>									<td class="text-center"><strong>'.$i.'</strong></td>									<td><a href="javascript:void(0);">'.$db[0]['nama_barang'].'</a></td>									<td class="text-center">'.$dgd[$k]['jumlah'].'</td>									<td>'.$db[0]['berat'].'</td>									<td>'.$total_berat.'</td>								</tr>';				$grand_total+=$total_berat;				$i++;			}		}		$detail_content.='<tr>										<td colspan="4">GRAND TOTAL</td>										<td><strong>'.$grand_total.' Kg</strong></td>									</tr>								</tbody>							</table>';		$data['no_surat_jalan'] = $no_surat_jalan;		$data['detail_content'] = $detail_content;		$data['customer'] = $dc[0];		$html = $this->load->view("print_surat_jalan.tpl", $data, true);		//echo $html;		$this->pdf_create($html,"test.pdf");	}		public function print_invoice(){		 /*   $printer="Microsoft XPS Document Writer";		   $content = "Test Donk cooooy\n";		   $content.="=============================================================================== \n           Terima Kasih \n ESC c 3 0";		   $ph = printer_open($printer);		   if($ph)			{			   printer_start_doc($ph, "Invoice");			   printer_start_page($ph);			   $font=printer_create_font("Arial",25,6,PRINTER_FW_THIN,false,false,false,0); 			   printer_set_option($ph, PRINTER_MODE, "raw");			   printer_set_option($ph, PRINTER_PAPER_FORMAT, PRINTER_FORMAT_LETTER);			   printer_select_font($ph,$font);			   printer_write($ph, $content);			   printer_end_page($ph);			   printer_end_doc($ph);			   printer_close($ph);			   //echo $content;			} */		$this->db->select("*")->from("transaksi_penjualan")->where("ref_code",$this->uri->segment(3));		$q = $this->db->get();		$d = $q->result_array();				$this->db->select("*")->from("transaksi_penjualan_detail")->where("ref_code",$this->uri->segment(3));		$qd = $this->db->get();		$dd = $qd->result_array();				$this->db->select("*")->from("customers")->where("idcustomer",$d[0]['idcustomer']);		$qc = $this->db->get();		$dc = $qc->result_array();				$data['penjualan'] = $d[0];		$data['penjualan_detail'] = $dd;		$data['customer'] = $dc[0];		$this->parser->parse("invoice.tpl", $data);		//$this->load->view('invoice.tpl',$data);	}		function pdf_create($html, $filename, $paper_size="a4", $footer="yes", $height="",$orientation="portrait", $stream=TRUE) 	{				require_once("dompdf/dompdf_config.inc.php"); 		$base_path = base_url();				$dompdf = new DOMPDF();		if($paper_size=="struk"){			$dompdf->set_paper(array(0,0,200,$height), "portrait" );		}		else{			if($paper_size=="faktur"){				$dompdf->set_paper(array(0,0,595,$height), "portrait" );			}			else{				$dompdf->set_paper($paper_size, $orientation);			}		}		 $dompdf->load_html($html);				 $dompdf->set_base_path($base_path);				//$dompdf->set_paper($paper, $orientation);		$options["Attachment"] = 0 ;		$dompdf->render();		$dompdf->stream($filename, $options);	}}?>	